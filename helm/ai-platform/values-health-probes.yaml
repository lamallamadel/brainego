# Health probe configuration for all services
# These values can be merged with main values.yaml

# Circuit breaker and fallback configuration
circuitBreaker:
  enabled: true
  failureThreshold: 3
  timeoutSeconds: 5
  recoveryTimeoutSeconds: 30
  successThreshold: 2

fallbackChain:
  enabled: true
  ollamaCpuEndpoint: "http://ollama-cpu:11434"  # Optional Ollama fallback
  cacheEnabled: true
  degradedMessage: "Service temporarily unavailable. Please try again later."

# Graceful shutdown configuration
gracefulShutdown:
  enabled: true
  terminationGracePeriodSeconds: 30
  preStopDelaySeconds: 5

# MAX Serve Llama health probes
maxServeLlama:
  livenessProbe:
    httpGet:
      path: /health
      port: 8080
      scheme: HTTP
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 8080
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  startupProbe:
    httpGet:
      path: /health
      port: 8080
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 30
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5"]

# MAX Serve Qwen health probes
maxServeQwen:
  livenessProbe:
    httpGet:
      path: /health
      port: 8081
      scheme: HTTP
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 8081
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  startupProbe:
    httpGet:
      path: /health
      port: 8081
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 30
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5"]

# MAX Serve DeepSeek health probes
maxServeDeepseek:
  livenessProbe:
    httpGet:
      path: /health
      port: 8082
      scheme: HTTP
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 8082
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  startupProbe:
    httpGet:
      path: /health
      port: 8082
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 30
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5"]

# API Server health probes
apiServer:
  livenessProbe:
    httpGet:
      path: /health
      port: 8000
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 8000
      scheme: HTTP
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  startupProbe:
    httpGet:
      path: /health
      port: 8000
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 20
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5 && pkill -SIGTERM python"]

# Gateway health probes
gateway:
  livenessProbe:
    httpGet:
      path: /health
      port: 9002
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 9002
      scheme: HTTP
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  startupProbe:
    httpGet:
      path: /health
      port: 9002
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 20
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5 && pkill -SIGTERM python"]

# MCP Jungle Gateway health probes
mcpjungleGateway:
  livenessProbe:
    httpGet:
      path: /health
      port: 9100
      scheme: HTTP
    initialDelaySeconds: 40
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 9100
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  startupProbe:
    httpGet:
      path: /health
      port: 9100
      scheme: HTTP
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 30
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5 && pkill -SIGTERM python"]

# Qdrant health probes
qdrant:
  livenessProbe:
    httpGet:
      path: /health
      port: 6333
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 6333
      scheme: HTTP
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5"]

# Redis health probes
redis:
  livenessProbe:
    exec:
      command:
        - redis-cli
        - ping
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    exec:
      command:
        - redis-cli
        - ping
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "redis-cli SHUTDOWN SAVE && sleep 5"]

# PostgreSQL health probes
postgres:
  livenessProbe:
    exec:
      command:
        - /bin/sh
        - -c
        - pg_isready -U ai_user -d ai_platform
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    exec:
      command:
        - /bin/sh
        - -c
        - pg_isready -U ai_user -d ai_platform
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "pg_ctl stop -m smart && sleep 10"]

# Neo4j health probes
neo4j:
  livenessProbe:
    httpGet:
      path: /
      port: 7474
      scheme: HTTP
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /
      port: 7474
      scheme: HTTP
    initialDelaySeconds: 40
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 10"]

# MinIO health probes
minio:
  livenessProbe:
    httpGet:
      path: /minio/health/live
      port: 9000
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /minio/health/ready
      port: 9000
      scheme: HTTP
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5"]

# Learning Engine health probes
learningEngine:
  livenessProbe:
    httpGet:
      path: /health
      port: 8003
      scheme: HTTP
    initialDelaySeconds: 40
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 8003
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  startupProbe:
    httpGet:
      path: /health
      port: 8003
      scheme: HTTP
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 30
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 10 && pkill -SIGTERM python"]

# Drift Monitor health probes
driftMonitor:
  livenessProbe:
    httpGet:
      path: /health
      port: 8004
      scheme: HTTP
    initialDelaySeconds: 40
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 8004
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 5 && pkill -SIGTERM python"]

# MAML Service health probes
mamlService:
  livenessProbe:
    httpGet:
      path: /health
      port: 8005
      scheme: HTTP
    initialDelaySeconds: 50
    periodSeconds: 30
    timeoutSeconds: 10
    successThreshold: 1
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: 8005
      scheme: HTTP
    initialDelaySeconds: 40
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  startupProbe:
    httpGet:
      path: /health
      port: 8005
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 40
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "sleep 10 && pkill -SIGTERM python"]
