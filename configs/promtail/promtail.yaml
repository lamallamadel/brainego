# Promtail Configuration
# Collects logs from Docker containers and ships to Loki

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # Gateway logs
  - job_name: gateway
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/gateway'
        action: keep
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            trace_id: trace_id
            span_id: span_id
      - labels:
          level:
          logger:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # MCPJungle Gateway logs
  - job_name: mcpjungle-gateway
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/mcpjungle-gateway'
        action: keep
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            trace_id: trace_id
            span_id: span_id
            mcp_server: mcp_server
            mcp_operation: mcp_operation
      - labels:
          level:
          logger:
          mcp_server:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # API Server logs
  - job_name: api-server
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/api-server'
        action: keep
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            trace_id: trace_id
      - labels:
          level:
          logger:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # MAX Serve logs
  - job_name: max-serve
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(max-serve-.*)'
        action: keep
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            model: model
            batch_size: batch_size
            latency_ms: latency_ms
      - labels:
          level:
          model:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # Memory Service logs
  - job_name: memory-service
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/api-server'
        action: keep
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            user_id: user_id
            session_id: session_id
            operation: operation
      - labels:
          level:
          logger:
          operation:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # Learning Engine logs
  - job_name: learning-engine
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/learning-engine'
        action: keep
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            task_id: task_id
            epoch: epoch
            loss: loss
      - labels:
          level:
          logger:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # Drift Monitor logs
  - job_name: drift-monitor
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/drift-monitor'
        action: keep
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            drift_score: drift_score
            threshold: threshold
      - labels:
          level:
          logger:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # Data Collection logs
  - job_name: data-collection
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/data-collection'
        action: keep
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            source: source
      - labels:
          level:
          logger:
          source:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
